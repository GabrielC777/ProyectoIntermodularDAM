\doxysubsection{Audio\+Service.\+cs}
\hypertarget{a00050_source}{}\label{a00050_source}\index{BetaProyecto/Services/AudioService.cs@{BetaProyecto/Services/AudioService.cs}}
\doxymbox{\hyperlink{a00050}{Ir a la documentación de este archivo.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{a00050_source_l00001}00001\ \textcolor{keyword}{using\ }System;}
\DoxyCodeLine{\Hypertarget{a00050_source_l00002}00002\ \textcolor{keyword}{using\ }System.IO;}
\DoxyCodeLine{\Hypertarget{a00050_source_l00003}00003\ \textcolor{keyword}{using\ }System.Linq;}
\DoxyCodeLine{\Hypertarget{a00050_source_l00004}00004\ \textcolor{keyword}{using\ }System.Net.Http;}
\DoxyCodeLine{\Hypertarget{a00050_source_l00005}00005\ \textcolor{keyword}{using\ }System.Text.Json.Nodes;}
\DoxyCodeLine{\Hypertarget{a00050_source_l00006}00006\ \textcolor{keyword}{using\ }System.Threading.Tasks;}
\DoxyCodeLine{\Hypertarget{a00050_source_l00007}00007\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00008}00008\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00009}\doxymbox{\hyperlink{a00178}{00009}}\ \textcolor{keyword}{namespace\ }\doxymbox{\hyperlink{a00178}{BetaProyecto.Services}}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00010}00010\ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00011}\doxymbox{\hyperlink{a00325}{00011}}\ \ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{class\ }\doxymbox{\hyperlink{a00325_aad4ed21a732455dc21a8f841d8c42b76}{AudioService}}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00012}00012\ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00013}00013\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ URL\ de\ nuestra\ API\ }}
\DoxyCodeLine{\Hypertarget{a00050_source_l00014}\doxymbox{\hyperlink{a00325_ab0cf2df1d319e65c4f417bcd6b717326}{00014}}\ \ \ \ \ \ \ \ \ \textcolor{keyword}{private}\ \textcolor{keyword}{const}\ \textcolor{keywordtype}{string}\ \doxymbox{\hyperlink{a00325_ab0cf2df1d319e65c4f417bcd6b717326}{API\_URL}}\ =\ \textcolor{stringliteral}{"{}https://localhost:7500/api/Music/stream"{}};}
\DoxyCodeLine{\Hypertarget{a00050_source_l00015}00015\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00016}\doxymbox{\hyperlink{a00325_a6a9204ae2d8afe00924cc6575d9c7dd8}{00016}}\ \ \ \ \ \ \ \ \ \textcolor{keyword}{private}\ readonly\ HttpClient\ \doxymbox{\hyperlink{a00325_a6a9204ae2d8afe00924cc6575d9c7dd8}{\_httpClient}};}
\DoxyCodeLine{\Hypertarget{a00050_source_l00017}\doxymbox{\hyperlink{a00329}{00017}}\ \ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ \textcolor{keyword}{class\ }\doxymbox{\hyperlink{a00329}{InfoCancionNube}}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00018}00018\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00019}\doxymbox{\hyperlink{a00329_a3a51230203c8a68976b91746e05a69da}{00019}}\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ \textcolor{keywordtype}{string}\ \doxymbox{\hyperlink{a00329_a3a51230203c8a68976b91746e05a69da}{Url}}\ \{\ \textcolor{keyword}{get};\ \textcolor{keyword}{set};\ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00020}\doxymbox{\hyperlink{a00329_a651774e6044b9512651f698fd5ed16fb}{00020}}\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ \textcolor{keywordtype}{int}\ \doxymbox{\hyperlink{a00329_a651774e6044b9512651f698fd5ed16fb}{DuracionSegundos}}\ \{\ \textcolor{keyword}{get};\ \textcolor{keyword}{set};\ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00021}00021\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00022}00022\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00023}\doxymbox{\hyperlink{a00325_aad4ed21a732455dc21a8f841d8c42b76}{00023}}\ \ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ \doxymbox{\hyperlink{a00325_aad4ed21a732455dc21a8f841d8c42b76}{AudioService}}()}
\DoxyCodeLine{\Hypertarget{a00050_source_l00024}00024\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00025}00025\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Esto\ le\ dice\ a\ la\ App:\ "{}No\ te\ quejes\ si\ el\ certificado\ del\ servidor\ es\ 'raro'\ o\ de\ desarrollo"{}.}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00026}00026\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Sin\ esto\ evitamos\ que\ falle\ la\ conexión\ HTTPS}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00027}00027\ \ \ \ \ \ \ \ \ \ \ \ \ var\ handler\ =\ \textcolor{keyword}{new}\ HttpClientHandler();}
\DoxyCodeLine{\Hypertarget{a00050_source_l00028}00028\ \ \ \ \ \ \ \ \ \ \ \ \ handler.ServerCertificateCustomValidationCallback\ =\ (message,\ cert,\ chain,\ errors)\ =>\ \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{a00050_source_l00029}00029\ \ \ \ \ \ \ \ \ \ \ \ \ \doxymbox{\hyperlink{a00325_a6a9204ae2d8afe00924cc6575d9c7dd8}{\_httpClient}}\ =\ \textcolor{keyword}{new}\ HttpClient(handler);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00030}00030\ \ \ \ \ \ \ \ \ \}\textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00031}00031\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <summary>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00032}00032\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ Solicita\ de\ forma\ asíncrona\ la\ extracción\ y\ el\ análisis\ de\ metadatos\ de\ un\ recurso\ de\ YouTube\ a\ través\ de\ una\ API\ externa.}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00033}00033\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ </summary>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00034}00034\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <remarks>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00035}00035\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ Este\ método\ gestiona\ la\ comunicación\ con\ el\ microservicio\ de\ streaming\ mediante\ los\ siguientes\ pasos:}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00036}00036\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <list\ type="{}number"{}>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00037}00037\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <item><b>Construcción:</b>\ Genera\ una\ URI\ de\ consulta\ codificando\ la\ <paramref\ name="{}urlYoutube"{}/>\ como\ parámetro.</item>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00038}00038\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <item><b>Petición:</b>\ Realiza\ una\ llamada\ GET\ utilizando\ el\ <c>HttpClient</c>\ configurado.</item>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00039}00039\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <item><b>Procesamiento:</b>\ Si\ la\ respuesta\ es\ exitosa,\ deserializa\ el\ cuerpo\ JSON\ para\ extraer\ la\ URL\ del\ flujo\ de\ audio\ y\ la\ duración\ total\ en\ segundos.</item>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00040}00040\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ </list>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00041}00041\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ En\ caso\ de\ fallo\ en\ la\ red\ o\ error\ en\ el\ servidor,\ captura\ la\ excepción\ y\ devuelve\ <c>null</c>\ para\ evitar\ cierres\ inesperados.}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00042}00042\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ </remarks>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00043}00043\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <param\ name="{}urlYoutube"{}>La\ dirección\ URL\ completa\ del\ video\ de\ YouTube\ que\ se\ desea\ procesar.</param>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00044}00044\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <returns>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00045}00045\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ Un\ objeto\ <see\ cref="{}InfoCancionNube"{}/>\ con\ la\ URL\ de\ streaming\ y\ la\ duración;\ }}
\DoxyCodeLine{\Hypertarget{a00050_source_l00046}00046\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ devuelve\ <c>null</c>\ si\ la\ API\ no\ responde\ correctamente\ o\ el\ recurso\ no\ es\ válido.}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00047}00047\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ </returns>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00048}\doxymbox{\hyperlink{a00325_a055a82e08bb605bfbce3aecd707eb5c3}{00048}}\ \ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ async\ Task<InfoCancionNube>\ \doxymbox{\hyperlink{a00325_a055a82e08bb605bfbce3aecd707eb5c3}{ObtenerMp3}}(\textcolor{keywordtype}{string}\ urlYoutube)}
\DoxyCodeLine{\Hypertarget{a00050_source_l00049}00049\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00050}00050\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00051}00051\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00052}00052\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Construimos\ la\ petición:\ https://localhost:7500/api/Music/stream?url=...}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00053}00053\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ urlPeticion\ =\ \$\textcolor{stringliteral}{"{}\{API\_URL\}?url=\{urlYoutube\}"{}};}
\DoxyCodeLine{\Hypertarget{a00050_source_l00054}00054\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00055}00055\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Llamamos\ al\ servidor}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00056}00056\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ var\ respuesta\ =\ await\ \doxymbox{\hyperlink{a00325_a6a9204ae2d8afe00924cc6575d9c7dd8}{\_httpClient}}.GetAsync(urlPeticion);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00057}00057\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00058}00058\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (respuesta.IsSuccessStatusCode)}
\DoxyCodeLine{\Hypertarget{a00050_source_l00059}00059\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00060}00060\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Leemos\ la\ respuesta\ (que\ es\ un\ texto\ JSON)}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00061}00061\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ jsonString\ =\ await\ respuesta.Content.ReadAsStringAsync();}
\DoxyCodeLine{\Hypertarget{a00050_source_l00062}00062\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00063}00063\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Sacamos\ el\ valor\ de\ "{}url"{}}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00064}00064\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ var\ nodoJson\ =\ JsonNode.Parse(jsonString);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00065}00065\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00066}00066\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{new}\ \doxymbox{\hyperlink{a00329}{InfoCancionNube}}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00067}00067\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00068}00068\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Url\ =\ nodoJson[\textcolor{stringliteral}{"{}url"{}}]?.ToString(),}
\DoxyCodeLine{\Hypertarget{a00050_source_l00069}00069\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Si\ 'duracion'\ viene\ nulo,\ ponemos\ 0}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00070}00070\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ DuracionSegundos\ =\ nodoJson[\textcolor{stringliteral}{"{}duracion"{}}]\ !=\ \textcolor{keyword}{null}\ ?\ (int)nodoJson[\textcolor{stringliteral}{"{}duracion"{}}]\ :\ 0}
\DoxyCodeLine{\Hypertarget{a00050_source_l00071}00071\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \};}
\DoxyCodeLine{\Hypertarget{a00050_source_l00072}00072\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00073}00073\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00074}00074\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{catch}\ (Exception\ ex)}
\DoxyCodeLine{\Hypertarget{a00050_source_l00075}00075\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00076}00076\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ System.Diagnostics.Debug.WriteLine(\textcolor{stringliteral}{"{}Error\ llamando\ a\ la\ API:\ "{}}\ +\ ex.Message);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00077}00077\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00078}00078\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00079}00079\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ \textcolor{keyword}{null};}
\DoxyCodeLine{\Hypertarget{a00050_source_l00080}00080\ \ \ \ \ \ \ \ \ \}\textcolor{comment}{}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00081}00081\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <summary>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00082}00082\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ Gestiona\ la\ descarga,\ protección\ mediante\ cifrado\ y\ recuperación\ de\ archivos\ de\ audio\ en\ el\ almacenamiento\ local.}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00083}00083\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ </summary>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00084}00084\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <remarks>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00085}00085\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ Este\ método\ implementa\ un\ sistema\ de\ seguridad\ y\ caché\ distribuido\ en\ dos\ niveles:}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00086}00086\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <list\ type="{}number"{}>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00087}00087\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <item><b>Caché\ persistente\ (.enc):</b>\ Si\ el\ archivo\ no\ existe,\ se\ descarga\ de\ internet,\ se\ cifra\ mediante\ AES\ y\ se\ guarda\ en\ la\ carpeta\ de\ datos\ locales\ de\ la\ aplicación.</item>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00088}00088\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <item><b>Caché\ temporal\ (.mp3):</b>\ Para\ permitir\ la\ reproducción\ en\ el\ motor\ de\ audio\ (VLC),\ el\ archivo\ se\ desencripta\ "{}on-\/the-\/fly"{}\ hacia\ una\ ruta\ temporal\ volátil.</item>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00089}00089\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <item><b>Optimización:</b>\ Si\ el\ archivo\ ya\ ha\ sido\ procesado\ previamente,\ evita\ la\ descarga\ redundante\ y\ prioriza\ la\ recuperación\ desde\ el\ disco.</item>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00090}00090\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ </list>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00091}00091\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ En\ caso\ de\ error\ crítico\ durante\ el\ cifrado\ o\ acceso\ a\ disco,\ el\ método\ retorna\ la\ URL\ original\ como\ mecanismo\ de\ contingencia.}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00092}00092\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ </remarks>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00093}00093\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <param\ name="{}url"{}>La\ dirección\ URL\ de\ origen\ del\ flujo\ de\ audio.</param>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00094}00094\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <param\ name="{}idCancion"{}>Identificador\ único\ de\ la\ canción,\ utilizado\ para\ nombrar\ los\ archivos\ en\ el\ almacenamiento\ físico.</param>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00095}00095\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ <returns>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00096}00096\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ Una\ cadena\ con\ la\ ruta\ local\ al\ archivo\ MP3\ desencriptado\ listo\ para\ su\ reproducción,\ }}
\DoxyCodeLine{\Hypertarget{a00050_source_l00097}00097\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ o\ la\ URL\ original\ si\ ocurre\ una\ excepción.}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00098}00098\ \textcolor{comment}{\ \ \ \ \ \ \ \ ///\ </returns>}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00099}\doxymbox{\hyperlink{a00325_afbf728ba83d0b3776470151bb77d13ab}{00099}}\ \ \ \ \ \ \ \ \ \textcolor{keyword}{public}\ async\ Task<string>\ \doxymbox{\hyperlink{a00325_afbf728ba83d0b3776470151bb77d13ab}{ObtenerRutaAudioSegura}}(\textcolor{keywordtype}{string}\ url,\ \textcolor{keywordtype}{string}\ idCancion)}
\DoxyCodeLine{\Hypertarget{a00050_source_l00100}00100\ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00101}00101\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{try}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00102}00102\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00103}00103\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Definimos\ rutas}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00104}00104\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ carpetaStorage:\ Aquí\ guardaremos\ los\ archivos\ .enc\ (CIFRADOS).\ Es\ persistente.}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00105}00105\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ carpetaStorage\ =\ Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),\ \textcolor{stringliteral}{"{}BetaProyecto"{}},\ \textcolor{stringliteral}{"{}EncryptedStorage"{}});}
\DoxyCodeLine{\Hypertarget{a00050_source_l00106}00106\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ carpetaTemp:\ Aquí\ guardaremos\ temporalmente\ el\ .mp3\ (DESCIFRADO)\ para\ VLC.}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00107}00107\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ carpetaTemp\ =\ Path.Combine(Path.GetTempPath(),\ \textcolor{stringliteral}{"{}BetaProyectoMusicTemp"{}});}
\DoxyCodeLine{\Hypertarget{a00050_source_l00108}00108\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Nos\ aseguramos\ de\ que\ las\ carpetas\ existan}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00109}00109\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Directory.CreateDirectory(carpetaStorage);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00110}00110\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ Directory.CreateDirectory(carpetaTemp);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00111}00111\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00112}00112\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Rutas\ finales\ de\ los\ archivos}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00113}00113\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ rutaCifrada\ =\ Path.Combine(carpetaStorage,\ \$\textcolor{stringliteral}{"{}\{idCancion\}.enc"{}});}
\DoxyCodeLine{\Hypertarget{a00050_source_l00114}00114\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{string}\ rutaPlay\ =\ Path.Combine(carpetaTemp,\ \$\textcolor{stringliteral}{"{}\{idCancion\}.mp3"{}});}
\DoxyCodeLine{\Hypertarget{a00050_source_l00115}00115\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00116}00116\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ COMPROBAR\ CACHÉ\ (¿Ya\ la\ hemos\ descargado\ antes?)}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00117}00117\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (File.Exists(rutaCifrada))}
\DoxyCodeLine{\Hypertarget{a00050_source_l00118}00118\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00119}00119\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ System.Diagnostics.Debug.WriteLine(\$\textcolor{stringliteral}{"{}[CACHE]\ Canción\ cifrada\ encontrada\ en\ disco."{}});}
\DoxyCodeLine{\Hypertarget{a00050_source_l00120}00120\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00121}00121\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Si\ ya\ tenemos\ el\ temporal\ listo,\ lo\ usamos\ directo\ para\ ir\ rápido}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00122}00122\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{if}\ (File.Exists(rutaPlay))\ \textcolor{keywordflow}{return}\ rutaPlay;}
\DoxyCodeLine{\Hypertarget{a00050_source_l00123}00123\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00124}00124\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Si\ no\ está\ el\ temporal,\ usamos\ el\ Encriptador\ para\ "{}abrir\ el\ candado"{}}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00125}00125\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Lee\ el\ .enc\ -\/>\ Usa\ la\ clave\ AES\ -\/>\ Escribe\ el\ .mp3}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00126}00126\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ \doxymbox{\hyperlink{a00176}{Helpers}}.\doxymbox{\hyperlink{a00249}{Encriptador}}.\doxymbox{\hyperlink{a00249_a22a5596da2f6e5aa5318995ed203697c}{DesencriptarArchivo}}(rutaCifrada,\ rutaPlay);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00127}00127\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00128}00128\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ rutaPlay;}
\DoxyCodeLine{\Hypertarget{a00050_source_l00129}00129\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00130}00130\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00131}00131\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ DESCARGAR\ Y\ PROTEGER\ (Si\ no\ la\ tenemos)}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00132}00132\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ System.Diagnostics.Debug.WriteLine(\$\textcolor{stringliteral}{"{}[RED]\ Descargando\ audio..."{}});}
\DoxyCodeLine{\Hypertarget{a00050_source_l00133}00133\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00134}00134\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Descargamos\ los\ bytes\ crudos\ de\ internet}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00135}00135\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ var\ datosAudio\ =\ await\ \doxymbox{\hyperlink{a00325_a6a9204ae2d8afe00924cc6575d9c7dd8}{\_httpClient}}.GetByteArrayAsync(url);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00136}00136\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00137}00137\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ System.Diagnostics.Debug.WriteLine(\$\textcolor{stringliteral}{"{}[SEGURIDAD]\ Cifrando\ con\ AES..."{}});}
\DoxyCodeLine{\Hypertarget{a00050_source_l00138}00138\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00139}00139\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Usamos\ el\ Encriptador\ para\ "{}cerrar\ el\ candado"{}\ antes\ de\ guardar}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00140}00140\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{byte}[]\ datosCifrados\ =\ \doxymbox{\hyperlink{a00176}{Helpers}}.\doxymbox{\hyperlink{a00249}{Encriptador}}.\doxymbox{\hyperlink{a00249_a465982b664017a61bfd486465378b909}{EncriptarBytes}}(datosAudio);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00141}00141\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00142}00142\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Guardamos\ la\ versión\ CIFRADA\ (Esta\ es\ la\ que\ se\ queda\ en\ el\ disco\ duro)}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00143}00143\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ File.WriteAllBytesAsync(rutaCifrada,\ datosCifrados);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00144}00144\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00145}00145\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Guardamos\ la\ versión\ DESCIFRADA\ temporalmente\ (Solo\ para\ que\ VLC\ la\ reproduzca\ ahora)}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00146}00146\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ await\ File.WriteAllBytesAsync(rutaPlay,\ datosAudio);}
\DoxyCodeLine{\Hypertarget{a00050_source_l00147}00147\ }
\DoxyCodeLine{\Hypertarget{a00050_source_l00148}00148\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ rutaPlay;}
\DoxyCodeLine{\Hypertarget{a00050_source_l00149}00149\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00150}00150\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{catch}\ (Exception\ ex)}
\DoxyCodeLine{\Hypertarget{a00050_source_l00151}00151\ \ \ \ \ \ \ \ \ \ \ \ \ \{}
\DoxyCodeLine{\Hypertarget{a00050_source_l00152}00152\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ System.Diagnostics.Debug.WriteLine(\$\textcolor{stringliteral}{"{}[ERROR]\ Fallo\ en\ descarga\ segura:\ \{ex.Message\}"{}});}
\DoxyCodeLine{\Hypertarget{a00050_source_l00153}00153\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Si\ algo\ falla,\ devolvemos\ la\ URL\ original\ para\ intentar\ streaming\ directo\ que\ lo\ mas\ seguro\ es\ que\ falle,}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00154}00154\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ pero\ al\ menos\ no\ se\ crasea\ la\ app.}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00155}00155\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordflow}{return}\ url;}
\DoxyCodeLine{\Hypertarget{a00050_source_l00156}00156\ \ \ \ \ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00157}00157\ \ \ \ \ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00158}00158\ \ \ \ \ \}}
\DoxyCodeLine{\Hypertarget{a00050_source_l00159}00159\ \}}

\end{DoxyCode}
